<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>KawalPemilu - Jaga Suara 2019</title>
  <style type="text/css">
    #navigasi { margin: 10px 0; }
    #column_list { margin: 10px 0; }
    .tps td { white-space: nowrap; }
    .aggregate tr:nth-child(even) { background: #EEE; }
    .aggregate tr:nth-child(odd) { background: #FFF; }
    .aggregate tbody > tr:hover { background-color: #CCF; }
    #header { background-color: #CCC; }
    #header { cursor: pointer; }
    .aggregate td { padding: 5px; font-family: verdana; font-size:11px; }
    .aggregate thead > tr > th { padding:8px; margin:8px; }
    .delta { font-size:9px; }
    .delta.complete {}
    .delta.incomplete { color: #888; }
    .aggregate tr.total td:first-child { text-align: right; }
    .aggregate tr.total td { background: #ccc; font-weight: bold; }
    .win { background-color: "lightgreen"; }
    .winmistake { background-color: "lightgreen"; color: "red"; }
    .lose { background-color: "lightpink"; }
    .losemistake { background-color: "lightpink"; }
    .mistake { background-color: "lightpink"; }
    .c1diff { border: 2px solid red; }
    .red { color: red; font-weight: bold }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
    function xhr(url, cb) {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", function () {
        cb(this.responseText);
      });
      oReq.open("GET", url);
      oReq.send();
    }

    function get(id, cb) {
      var url = 'https://kawal-c1.appspot.com/api/c/';
      xhr(url + id + '?' + new Date().getTime(), function (res) {
        cb(JSON.parse(res));
      });
    }

    function render() {
      var h = document.location.hash;
      var id = parseInt(h && h.length && h.substring(1), 10);
      id = isNaN(id) ? 0 : id;
      get(id, function (c) {
        console.log(JSON.stringify(c, null, 2));
        document.getElementById('navigasi').innerHTML = renderNavigasi(c);
        var isHierarchyTable = c.depth < 4;
        document.getElementById('tabulasi').innerHTML = isHierarchyTable ? renderHierarchy(c) : renderTps(c);
        if (!isColumnListRendered) {
          document.getElementById('column_list').innerHTML = renderColumnList();
        } else if (isHierarchyTable) {
          $('#column_list').show();
          for (var i = 2; i < columnNamesList.length; i++) {
            hideShowColumn(i);
          }
        } else {
          $('#column_list').hide();
        }
      });
    }

    function renderNavigasi(c) {
      var s = '';
      for (var i = 0; i < c.parentIds.length; i++) {
        var pid = c.parentIds[i];
        var pname = c.parentNames[i];
        s += '<a href="#' + pid + '">' + pname + '</a> &gt;&nbsp; ';
      }
      s += c.name;
      return s;
    }

    var columnNamesList;
    var isColumnListRendered = false;

    function renderColumnList() {
      isColumnListRendered = true;
      var s = '';
      for (var i = 2; i < columnNamesList.length; i++) {
        s += '<input type="checkbox" checked="checked" id="colCheckbox' + i + '"onclick="hideShowColumn(' + i + ')">' + columnNamesList[i] + '&nbsp;&nbsp;</input>';
      }
      return s;
    }

    function hideShowColumn(i) {
      var checkbox = document.getElementById('colCheckbox' + i);
      var index = i + 1;
      if (checkbox.checked) {
        $('td:nth-child(' + index + '),th:nth-child(' + index + ')').show();
      } else {
        $('td:nth-child(' + index + '),th:nth-child(' + index + ')').hide();
      }
    }

    function renderHierarchy(c) {
      var columns = {
        '#': function (i) { return i + 1; },
        'Nama Wilayah': function (i) {
          var cid = c.children[i][0];
          var cname = c.children[i][1];
          return '<a href="#' + cid + '">' + cname + '</a>';
        },
        'Jokowi-Amin': function (i, data) { return (data && data.sum && data.sum.pas1) || 0; },
        'Prabowo-Sandi': function (i, data) { return (data && data.sum && data.sum.pas2) || 0; },
        'Jumlah': function (i, data) { return (data && data.sum && data.sum.jum) || 0; },
        'Suara Sah': function (i, data) { return (data && data.sum && data.sum.sah) || 0; },
        'Tidak Sah': function (i, data) { return (data && data.sum && data.sum.tSah) || 0; },

        'TPS Error': function (i, data) { return (data && data.sum && data.sum.error) || 0; },
        'Cakupan': function (i, data) { return (data && data.sum && data.sum.cakupan) || 0; },
        'Pending': function (i, data) { return (data && data.sum && data.sum.pending) || 0; },
        'nTPS': function (i) { return c.children[i][2]; },
        'nDPT': function (i) {
          var nL = c.children[i][3];
          var nP = c.children[i][4];
          return nL + nP;
        },
        // Tambahin as necessary (ada "pkb", "nas", etc untuk suara partai ).
      };

      var s = '<thead><tr class="header" id="header" bgcolor="#DDDDDD">';
      var colKeys = Object.keys(columns);
      for (var i = 0; i < colKeys.length; i++) {
        s += '<th onclick="sort(' + i + ')">' + colKeys[i];
      }
      s += '</tr></thead><tbody>';

      //populate columnList
      if (!columnNamesList) {
        columnNamesList = [];
        for (var i = 0; i < colKeys.length; i++) {
          columnNamesList.push(colKeys[i]);
        }
      }

      for (var i = 0; i < c.children.length; i++) {
        var data = c.data[c.children[i][0]];
        s += '<tr class="datarow">';
        for (var j = 0; j < colKeys.length; j++) {
          var value = columns[colKeys[j]](i, data);
          var sortValue = ($(value).text()) ? $(value).text() : value;
          s += '<td data-sort-index="' + j + '" data-sort="' + sortValue + '" ' + renderCellStyle(j) + '>' + format(value);
        }
      }
      return s + '</tbody>';
    }

    function renderCellStyle(c) {
      if (c === 0) {
        return 'align="center"';
      } else if (c === 1) {
        return 'align="left"';
      } else {
        return 'align="right"';
      }
    }

    function tpsSum(key, data) {
       return (data && data.sum && data.sum[key]) || 0 ;;
    }

    function summarize( key, data, sumKeys, sortIdx) {
        var keys = sumKeys[key];
        var result = '';
        for (var j = 0; j < keys.length; j++) {
              var key = keys[j];
              var value = tpsSum(key,data);
              var sortValue = ($(value).text()) ? $(value).text() : value;
              result += '<td data-sort-index="' + (sortIdx+j)+'" data-sort="'+sortValue+'">' + format(value) + '</td>';
            }
        return result;
    }

    function header(group, labels, sortIdx) {
        var result = '';
        var gLabels = labels[group];
        for (var j = 0; j < gLabels.length; j++) {
              result += '<th onClick="sort('+(sortIdx+j)+')" >'+gLabels[j]+'</th>';
        }
        return result;
    }


    function renderTps(c) { 
      console.log("TPS Data", c);
      var formType = ['SKIP_ZERO','PPWP','DPR','DPD','DPRP','DPRPB','DPRA','DPRD_PROV','DPRD_KAB_KOTA','DPRK','OTHERS','MALICIOUS'];
      var isPlano =  ['SKIP_ZERO', 'YES', 'NO'];    
      var sumKeys = { 
         'pilpres': ['pas1', 'pas2', 'jum', 'sah', 'tSah'],
         'pileg'  : [ 'pkb', 'ger', 'pdi', 'gol', 'nas', 'gar', 'ber', 'sej', 'per', 'ppp', 'psi', 'pan', 'han', 'dem', 
                      'pa',  'ps', 'pda', 'pna', // Partai lokal Aceh 
                      'pbb', 'pkp', 'pJum', 'pSah', 'pTSah' ],
         'tps' : [ 'cakupan', 'pending', 'error', 'janggal'],
      };
      var sumLabels = { 
         'pilpres': ['Jokowi-Amin', 'Prabowo-Sandi', 'Jumlah', 'Suara Sah', 'Tidak Sah'],
         'pileg'  : [ 'PKB', 'Gerindra', 'PDI', 'Golkar', 'Nasdem', 'Garuda', 'Berkarya', 'PKS', 'Perindo', 'PPP', 'PSI', 'PAN', 'Hanura', 'Demokrat', 
                      'PA',  'PS', 'PDA', 'PNA', // PARTAI LOKAL ACEH 
                      'PBB', 'PKP', 'Jumlah', 'Suara Sah', 'Tidak Sah' ],
         'tps' : [ 'Cakupan', 'Pending', 'Error', 'Janggal'],
      };


      var imageSize = '120';
      var s = '<thead><tr class="header" id="header"  bgcolor="#DDDDDD">';
      s += '<th colspan=5> Pilpres</th>';
      s += '<th colspan=23> Pileg </th>';
      s += '<th colspan=4> TPS </th>';
      s += '</tr><tr class="header" id="header" bgcolor="#DDDDDD">';
      s += header('pilpres', sumLabels, 0);
      s += header('pileg', sumLabels, 5);
      s += header('tps', sumLabels, 28);
      s += '</tr></thead>'; 


      s += '<tbody>';
      var nTps = c.children.length;
      for (var i = 0; i < nTps; i++) {
        var tpsRow = c.data[c.children[i][0]];

        s += '<tr class="datarow">';
        var tpsNo = c.children[i][0];
        var nDPT  = c.children[i][1] + c.children[i][2];
        //s += 'nDPT = '+ nDPT +'<br>';
        //s += 'TPS = #'+ tpsNo +'<br>';

        s += summarize('pilpres', tpsRow, sumKeys, 0);
        s += summarize('pileg', tpsRow, sumKeys, 5);
        s += summarize('tps', tpsRow, sumKeys, 28);

        if (tpsRow) {
          s += '<td>';
          var urls = Object.keys(tpsRow.photos);
          for (var j = 0; j < urls.length; j++) {
            var url = urls[j];
            var p = tpsRow.photos[url];
            s += '<div style="background-color: #DDD; title="';
            s += ' Upload date: ' + new Date(p.ts) ;
            s += ' Tipe form: ' + formType[p.c1.type] ;
            s += ' Plano: ' + isPlano[p.c1.plano]+ '">' ;
            //s += 'Sum: ' + JSON.stringify(p.sum) + '">';
            if(j == 0){		
                s += '<img src="' + url + '=s' + imageSize + '">';
            } else {
                s += '<a href="'+url+'"> foto: '+JSON.stringify(j)+ '</a>';
            }
            s += '</div>';
          }
	  s += '</td>';
        }
    
        s += '</tr>';
      }
      return s + '</tbody>';
    }

    var sortState = [1, 1];

    function sort(i) {
      var trs = $('table tr.datarow');
      var tds = $(trs[0]).find('td');
      var idx = 0;
      for (var j=0; j<tds.length; j++) {
        if ($(tds[j]).data('sort-index') == i) {
          idx = j + 1;
          break;
        }
      }

      var mul = 1;
      if (sortState[0] === idx) {
        mul = sortState[1] * -1;
      }
      sortState = [idx, mul];

      trs.sort(function(a, b) {
        var ka = $(a).find('td:nth-child('+idx+')').data('sort');
        var kb = $(b).find('td:nth-child('+idx+')').data('sort');
        if (!ka && !kb) return 0 * mul;
        if (!ka && !!kb) return -1 * mul;
        if (!!ka && !kb) return 1 * mul;
        if (!!ka.localeCompare) return ka.localeCompare(kb) * mul;
        return (ka - kb) * mul;
      });
      $(trs).detach();
      ($($('table tbody')[0])).append($(trs));
    }

    function format(str) {
      if (isNaN(str)) return str;
      if (str == 0) return '0';
      var nres = '' + str;
      var res = '';
      for (var i =0; i< nres.length;i++) {
        if (i > 0 && i%3 == 0) {
          res = '.' + res;
        }
        res = nres[nres.length-i-1] + res;
      }
      return res;
    }

    window.onload = render;
    window.onhashchange = render;
  </script>
</head>

<body>
  <h1>Hasil Data Uji Coba Kawal Pemilu 2019</h1>
  <p>Halaman ini berisi hasil tabulasi dari <strong>DATA UJI COBA</strong> yang sudah masuk ke <a href="https://upload.kawalpemilu.org">upload.kawalpemilu.org</a>.</p>
  <p>Pada hari pemungutan suara, data ini akan diganti dengan data asli yang dikumpulkan oleh relawan dari lapangan.</p>
  <div id="navigasi"></div>
  <div id="column_list"></div>
  <table class="aggregate" id="tabulasi"></table>
</body>

</html>
